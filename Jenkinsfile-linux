pipeline {

    agent {label 'master'}

    environment { 
        CI = 'true'
    }
    stages {

       stage('build') {

        parallel {

        stage('Build Linux Packages') {

            agent {
                label 'linux'
            }

            steps {
                catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE'){

                    sh 'cd /home/jenkins/go/src/infini.sh/agent && git stash && git pull origin master && make clean config build-linux-amd64-dev'
                    sh label: 'copy-configs', script: 'cd /home/jenkins/go/src/infini.sh/agent &&  cp ../framework/LICENSE bin && cat ../framework/NOTICE NOTICE > bin/NOTICE && cp README bin'

                    sh label: 'package-linux-amd64-dev', script: 'cd /home/jenkins/go/src/infini.sh/agent/bin && tar cfz ${WORKSPACE}/agent-$VERSION-$BUILD_NUMBER-linux-amd64-dev.tar.gz agent-linux-amd64-dev agent.yml LICENSE NOTICE README'

                    sh 'cd /home/jenkins/go/src/infini.sh/agent && git stash && git pull origin master && make clean config build-linux-amd64'
                    sh label: 'copy-configs', script: 'cd /home/jenkins/go/src/infini.sh/agent && cp ../framework/LICENSE bin && cat ../framework/NOTICE NOTICE > bin/NOTICE && cp README bin'

                    sh label: 'package-linux-amd64', script: 'cd /home/jenkins/go/src/infini.sh/agent/bin && tar cfz ${WORKSPACE}/agent-$VERSION-$BUILD_NUMBER-linux-amd64.tar.gz agent-linux-amd64 agent.yml  LICENSE NOTICE README'
		   
                    sh 'cd /home/jenkins/go/src/infini.sh/agent && git stash && git pull origin master && make clean config build-arm'
                    sh label: 'copy-configs', script: 'cd /home/jenkins/go/src/infini.sh/agent && cp ../framework/LICENSE bin && cat ../framework/NOTICE NOTICE > bin/NOTICE && cp README bin'

                    sh label: 'package-linux-arm64', script: 'cd /home/jenkins/go/src/infini.sh/agent/bin && tar cfz ${WORKSPACE}/agent-$VERSION-$BUILD_NUMBER-linux-arm64.tar.gz agent-linux-arm64 agent.yml  LICENSE NOTICE README'

                    archiveArtifacts artifacts: 'agent-$VERSION-$BUILD_NUMBER-*', fingerprint: true, followSymlinks: true, onlyIfSuccessful: false
                }
            }
         }
        }
      }
    }
}
